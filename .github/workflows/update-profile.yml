name: Profile Enhancement Pipeline

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-snake:
    name: Generate Contribution Snake
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Snake Animation
        uses: Platane/snk@v3
        with:
          github_user_name: CowLegSoup
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark&bg_color=%230d1117

      - name: Deploy Snake to Output Branch
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-3d-profile:
    name: Generate 3D Profile
    runs-on: ubuntu-latest
    needs: generate-snake
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Generate 3D Contribution Profile
        uses: yoshi389111/github-profile-3d-contrib@0.7.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: CowLegSoup
        with:
          USERNAME: CowLegSoup
          MAX_REPOS: 100
          SETTING_JSON: |
            {
              "type": "normal",
              "backgroundColor": "#0d1117",
              "foregroundColor": "#38bdae",
              "strongColor": "#70a5fd",
              "weakColor": "#bf91f3",
              "radarColor": "#ffb86c",
              "growingAnimation": true,
              "contribColors": [
                "#0d1117",
                "#1a1e23",
                "#2d333b",
                "#38bdae",
                "#70a5fd"
              ]
            }

      - name: Deploy 3D Profile
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: output
          build_dir: profile-3d-contrib
          keep_history: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    name: Update Profile README
    runs-on: ubuntu-latest
    needs: [generate-snake, generate-3d-profile]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Update Profile Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import requests
          import os
          from datetime import datetime
          
          headers = {'Authorization': f'token {os.environ["GITHUB_TOKEN"]}'}
          
          try:
              user_response = requests.get('https://api.github.com/users/CowLegSoup', headers=headers)
              user_data = user_response.json() if user_response.status_code == 200 else {}
              
              events_response = requests.get('https://api.github.com/users/CowLegSoup/events/public?per_page=5', headers=headers)
              events_data = events_response.json() if events_response.status_code == 200 else []
              
              print(f"Profile updated for: {user_data.get('name', 'CowLegSoup')}")
              print(f"Public repositories: {user_data.get('public_repos', 0)}")
              print(f"Recent activities: {len(events_data)}")
              
          except Exception as e:
              print(f"API Error: {e}")
          
          timestamp = datetime.now().strftime('%Y-%m-%d %H:%M UTC')
          print(f"Last updated: {timestamp}")
          EOF

      - name: Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Profile Bot"
          
          if git diff --quiet && git diff --staged --quiet; then
              echo "No changes detected"
          else
              git add .
              git commit -m "Update profile: $(date -u +'%Y-%m-%d %H:%M UTC')" || exit 0
              git push
              echo "Profile updated successfully"
          fi
